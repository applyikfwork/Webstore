
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // Allow admin users to read and write all documents
    function isAdmin() {
      return request.auth.uid != null;
    }

    // Rules for the 'apps' collection
    match /apps/{appId} {
      // Anyone can read app listings
      allow read: if true;
      
      // Only admins can create and delete apps
      allow create, delete: if isAdmin();

      // Allow admins to update all fields.
      // Allow anyone to update ONLY the 'downloads' field by incrementing it.
      allow update: if isAdmin() || 
        (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['downloads']) &&
         request.resource.data.downloads == resource.data.downloads + 1);
    }

    // Rules for the 'settings' collection
    match /settings/{settingId} {
      // Anyone can read settings (for site icon, etc.)
      allow read: if true;
      // Only admins can write settings
      allow write: if isAdmin();
    }
  }
}
